From 74b11605ce28741c2fdf181c4f626bf898ad8dc7 Mon Sep 17 00:00:00 2001
From: "Frederic Pierret (Epitre)" <frederic.epitre@orange.fr>
Date: Tue, 19 Sep 2017 20:23:52 +0200
Subject: [PATCH 27/30] anaconda: generate proper extlinux.conf

Fixes QubesOS/qubes-issues#2902
---
 pyanaconda/bootloader.py | 10 +++++++---
 1 file changed, 7 insertions(+), 3 deletions(-)

diff --git a/pyanaconda/bootloader.py b/pyanaconda/bootloader.py
index c8ed530..41dbf15 100644
--- a/pyanaconda/bootloader.py
+++ b/pyanaconda/bootloader.py
@@ -2364,6 +2364,8 @@ class EXTLINUX(BootLoader):
 
     def write_config_images(self, config):
         self.write_config_console(config)
+        xen_gz = [x for x in os.listdir(iutil.getSysroot() + self.config_dir) if
+                   x.startswith('xen-') and x.endswith('.gz')][0]
         for image in self.images:
             args = Arguments()
             args.update(["root=%s" % image.device.fstab_spec, "ro"])
@@ -2376,10 +2378,12 @@ class EXTLINUX(BootLoader):
             label = "%s(%s)" % (self.image_label(image), image.version)
             label = label.replace(" ", "")
             stanza = ("label %(label)s\n"
-                      "\tkernel %(boot_prefix)s/%(kernel)s\n"
-                      "\tinitrd %(boot_prefix)s/%(initrd)s\n"
-                      "\tappend %(args)s\n\n"
+                      "\tkernel mboot.c32\n"
+                      "\tappend %(boot_prefix)s/%(xen)s --- "
+                      "%(boot_prefix)s/%(kernel)s %(args)s --- "
+                      "%(boot_prefix)s/%(initrd)s\n"
                       % {"label": label,
+                         "xen": xen_gz,
                          "kernel": image.kernel,
                          "initrd": image.initrd,
                          "args": args,
-- 
2.9.5

